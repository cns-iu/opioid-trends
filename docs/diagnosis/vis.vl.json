{
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {
    "url": "../data/diagnosis-data-row-based.csv",
    "format": {
      "parse": {
        "PERIOD": "date",
        "VALUE": "number"
      }
    }
  },
  "transform": [
    {
      "calculate": "datum.VALUE/datum.TOTAL*100", "as": "(%)"
    }
  ],
  "vconcat": [
    {
      "spacing": 75,
      "columns": 4,
      "facet": {
        "field": "DATA_VARIABLE", 
        "type": "ordinal", 
        "title": ""
      },
      "bounds": "flush",
      "resolve": {"scale": {"x": "independent", "y": "independent"}},
      "spec": {
        "height": 100,
        "width": 150,
        "layer": [
          {
            "transform": [{"filter": {"selection": "labelpoints"}}],
            "mark": {"type": "rule", "color": "gray"},
            "encoding": {
              "x": {
                "type": "temporal",
                "field": "PERIOD",
                "scale": {"domain": {"selection": "period"}}
              }
            }
          },
          {
            "transform": [{ "filter": { "selection": "data_variable" } }],
            "encoding": {
              "x": {
                "field": "PERIOD", 
                "type": "temporal", 
                "title": "",
                "scale": { "domain": { "selection": "period" } }
              },
              "y": {
                "field": "(%)",
                "type": "quantitative",
                "axis": {"tickCount": 6},
                "scale": {"zero": false},
                "title": "% of Cohort"
              },
              "color": {
                "field": "COHORT", 
                "type": "nominal", 
                "title": "Cohort",
                "legend": {
                  "symbolType": "circle",
                  "orient": "right"
                }
              }
            },
            "layer": [
              {
                "mark": "line",
                "selection": {
                  "data_variable": {
                    "type": "multi",
                    "fields": ["COHORT"],
                    "bind": { "legend": "dblclick" },
                    "on": "true",
                    "clear": "dblclick",
                    "empty": "none",
                    "init": [
                      {"COHORT": "All"},
                      {"COHORT": "Chronic"},
                      {"COHORT": "Non-chronic"}
                    ]
                  }
                }
              },
              {
                "mark": {"type": "point", "filled": true},
                "encoding": {
                  "opacity": {
                    "condition": {
                      "selection": "labelpoints", 
                      "value": 1
                    },
                    "value": 0
                  }
                },
                "selection": {
                  "labelpoints": {
                    "type": "single",
                    "nearest": true,
                    "on": "mouseover",
                    "encodings": ["x"],
                    "empty": "none",
                    "clear": "mouseout"
                  }
                }
              }
            ]
          },
          {
            "transform": [{"filter": {"selection": {"and": ["labelpoints", "data_variable"]}}}],
            "encoding": {
              "x": {
                "type": "temporal",
                "field": "PERIOD",
                "scale": {"domain": {"selection": "period"}}
              },
              "y": {
                "type": "quantitative", 
                "field": "(%)"
              },
              "text": {
                "type": "quantitative",
                "field": "VALUE",
                "format": ",.4~f"
              }
            },
            "layer": [
              {
                "mark": {
                  "type": "text",
                  "stroke": "white",
                  "strokeWidth": 3,
                  "align": "left",
                  "clip": false
                }
              },
              {
                "mark": {
                  "type": "text", 
                  "align": "left", 
                  "clip": false
                },
                "encoding": {
                  "color": {
                    "field": "COHORT",
                    "type": "nominal",
                    "title": "Cohort"
                  }
                }
              }
            ]
          }
        ]
      }
    },
    {
      "width": 825,
      "height": 150,
      "encoding": {
        "x": {
          "type": "temporal", 
          "field": "PERIOD", 
          "title": null
        },
        "y": {
          "aggregate": "sum",
          "type": "quantitative",
          "field": "VALUE",
          "axis": {
            "orient": "right",
            "title": "Number of patients",
            "tickCount": 6,
            "grid": false
          }
        },
        "color": {
          "field": "COHORT", 
          "type": "nominal", 
          "title": "Cohort"
        },
        "opacity": {
          "condition": {
            "selection": "data_variable",
            "value": 1
          },
          "value": 0.1
        }
      },
      "layer": [
        {
          "mark": "line",
          "selection": {
            "period": {"type": "interval", "encodings": ["x"]}
          }
        }
      ]
    }
  ]
}