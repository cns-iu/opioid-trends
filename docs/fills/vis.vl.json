{
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "data": {"url": "..//data/fills-data-row-based.csv"},
  "transform": [
    {"calculate": "datum.VALUE/datum.TOTAL*100", "as": "(%)"}
  ],
  "padding": 10,
  "config": {
    "autosize": {
      "type": "pad"
    },

    "mark": { "tooltip": null }
  },
  "vconcat": [
    {
      "spacing": 30,
      "facet": {
        "field": "DATA_VARIABLE",
        "type": "ordinal",
        "title": ""
      },
      "resolve": {
        "scale": {"y": "independent"}
      },
      "spec": {
        "height": 200,
        "width": 200,
        "layer": [
          {
            "transform": [{ "filter": { "selection": "labelpoints" } }],
            "mark": {
              "type": "rule",
              "color": "gray"
            },
            "encoding": {
              "x": {
                "type": "temporal",
                "field": "PERIOD",
                "scale": { "domain": { "selection": "period" } }
              }
            }
          },
          {
            "encoding": {
              "x": {
                "field": "PERIOD",
                "type": "temporal",
                "scale": {"domain": { "selection": "period" }},
                "title": "",
                "axis": {
                  "offset": -5
                }
              },
              "y": {
                "field": "(%)", 
                "type": "quantitative",
                "scale": {"zero": false},
                "axis": {
                  "tickCount": 6
                },
                "title": "% of Cohort"
              },
              "color": {"field": "COHORT", "type": "nominal", "title": "Cohort"}
            },
            "layer": [
              {
                "mark": "line"
              },
              {
                "mark": {
                  "type": "point",
                  "filled": true
                },
                "encoding": {
                  "opacity": {
                    "condition": {
                      "selection": "labelpoints",
                      "value": 1
                    },
                    "value": 0
                  }
                },
                "selection": {
                  "labelpoints": {
                    "type": "single",
                    "nearest": true,
                    "on": "mouseover",
                    "encodings": ["x"],
                    "empty": "none"
                  }
                }
              }
            ]
          },
          {
            "transform": [{ "filter": { "selection": { "and": ["labelpoints"] } } }],

            "encoding": {
              "x": {
                "type": "temporal",
                "field": "PERIOD",
                "scale": { "domain": { "selection": "period" } }
              },
              "y": {
                "type": "quantitative",
                "field": "(%)"
              },

              "text": {
                "type": "quantitative",
                "field": "(%)",
                "format": ",.2~f"
              }
            },

            "layer": [
              {
                "transform": [{ "filter": "datum.PERIOD > 1491004800000" }],
                "mark": {
                  "type": "text",
                  "stroke": "white",
                  "strokeWidth": 3,
                  "align": "right",
                  "clip": true
                }
              },
              {
                "transform": [{ "filter": "datum.PERIOD > 1491004800000" }],
                "mark": {
                  "type": "text",
                  "align": "right",
                  "clip": true
                },
                "encoding": {
                "color": {"field": "COHORT", "type": "nominal", "title": "Cohort"}
                }
              },
              {
                "transform": [{ "filter": "datum.PERIOD <= 1491004800000" }],
                "mark": {
                  "type": "text",
                  "stroke": "white",
                  "strokeWidth": 3,
                  "align": "left",
                  "clip": true
                }
              },
              {
                "transform": [{ "filter": "datum.PERIOD <= 1491004800000" }],
                "mark": {
                  "type": "text",
                  "align": "left",
                  "clip": true
                },
                "encoding": {
                "color": {"field": "COHORT", "type": "nominal", "title": "Cohort"}
                }
              }
            ]
          }
        ]
      }
    },
    {
      "spacing": 30,
      "facet": {
        "field": "DATA_VARIABLE",
        "type": "ordinal",
        "title": ""
      },
      "resolve": {
        "scale": {"y": "independent"}
      },
      "spec": {
        "height": 200,
        "width": 200,
        "transform": [
          { "filter": { "selection": "period" } },
          {
            "joinaggregate": [{
              "op": "sum",
              "field": "VALUE",
              "as": "a"
            }],
            "groupby": ["COHORT", "DATA_VARIABLE"]
          },
          {
          "joinaggregate": [{
            "op": "sum",
            "field": "TOTAL",
            "as": "b"
          }],
          "groupby": ["COHORT", "DATA_VARIABLE"]
          },
          {"calculate": "datum.a/datum.b*100", "as": "percent"}
        ],
        "layer": [
          {
            "mark": "bar",
            "encoding": {
              "x": {
                "field": "COHORT",
                "type": "nominal",
                "title": "",
                "scale": {"domain": ["All", "Chronic", "Non-chronic"]}
              },
              "y": {
                "field": "percent",
                "type": "quantitative",
                "title": "% of Cohort",
                "axis": {
                  "labelFlush": true,
                  "tickCount": 10
                },
                "scale": {"domain": [0, 100]}
              },
              "color": {"field": "COHORT", "type": "nominal", "title": "Cohort"}
            }
          },
          {
            "mark": {
              "type": "text",
              "yOffset": -5
            },
            "encoding": {
              "text": {"field": "percent", "type": "quantitative", "format": ",.2~f"},
              "x": {
                "field": "COHORT",
                "type": "nominal",
                "title": ""
              },
              "y": {
                "field": "percent", 
                "type": "quantitative"
              }
            }
          }
        ]
      }
    },
    {
      "width": 660,
      "height": 150,
      "encoding": {
        "x": {
          "type": "temporal",
          "field": "PERIOD",
          "title": null
        },
        "y": {
          "aggregate": "sum",
          "type": "quantitative",
          "field": "VALUE",
          "axis": {
            "orient": "right",
            "title": "Number of patients",
            "tickCount": 6,
            "grid": false,
            "minExtent": 60
          }
        },
        "color": {"field": "COHORT", "type": "nominal", "title": "Cohort"}
      },
      "layer": [
        {
          "mark": "line",
          "selection": {
            "period": {
              "type": "interval",
              "encodings": ["x"]
            }
          }
        },
        {
          "transform": [{ "filter": "datum.COHORT == 'Chronic'" }],
          "mark": {
            "type": "line",
            "strokeDash": [20, 4]
          }
        },
        {
          "transform": [{ "filter": "datum.COHORT == 'Non-chronic'" }],
          "mark": {
            "type": "line",
            "strokeDash": [4, 4]
          }
        }
      ]
    }
  ]
}